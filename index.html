<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Lead</title>

    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@3.27.0/lib/msal-browser.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; }
        
        /* Custom UI Styles */
        .input-group { position: relative; }
        .input-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: #94a3b8; width: 16px; height: 16px; pointer-events: none; transition: color 0.2s;
        }
        .field {
            width: 100%; padding: 10px 12px 10px 36px; font-size: 0.875rem;
            color: #1e293b; background-color: #fff; border: 1px solid #e2e8f0;
            border-radius: 6px; transition: all 0.2s ease-in-out;
        }
        .field:disabled { background-color: #f8fafc; color: #94a3b8; cursor: not-allowed; }
        .field.no-icon { padding-left: 12px; }
        .field:hover:not(:disabled) { border-color: #cbd5e1; }
        .field:focus:not(:disabled) { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .field:focus + .input-icon { color: #3b82f6; }
        .section-label {
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.025em; color: #64748b; margin-bottom: 8px; display: block;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .status-select {
            appearance: none; background: transparent; border: none; padding: 0; margin: 0;
            font-size: 1rem; font-weight: 600; color: #0f172a; cursor: pointer; outline: none;
        }

        #partsDropdown {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            max-height: 220px; overflow-y: auto; background: white; border: 1px solid #e2e8f0;
            border-top: none; border-radius: 0 0 6px 6px; z-index: 50;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .part-option {
            padding: 10px 12px; font-size: 0.875rem; color: #1e293b;
            cursor: pointer; transition: background 0.1s; border-bottom: 1px solid #f8fafc;
        }
        .part-option:last-child { border-bottom: none; }
        .part-option:hover { background-color: #f1f5f9; color: #2563eb; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    
    <div class="shrink-0 px-5 py-5 border-b border-slate-100 bg-white z-20">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="relative flex items-center">
                    <select id="leadStatus" class="status-select pr-5">
                        <option value="Open">New Lead</option>
                        <option value="Ready for Quote">Ready for Quote</option>
                    </select>
                    <svg class="absolute right-0 w-3 h-3 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>
            <div id="statusDot" class="w-2.5 h-2.5 rounded-full bg-emerald-400 transition-colors duration-300 shadow-sm"></div>
        </div>
        <div id="alertBox" class="hidden mt-3 p-2 bg-red-50 border border-red-100 rounded text-xs text-red-600"></div>
    </div>

    <div class="flex-1 overflow-y-auto no-scrollbar bg-white">
        <form id="leadForm" class="px-5 py-6 space-y-6" onsubmit="return false;">
            <input type="hidden" id="internetMessageId" />
            <input type="hidden" id="conversationId" />
            <input type="hidden" id="receivedTime" />

            <div style="margin-top:0;">
                <label class="section-label">Contact Details</label>
                <div class="space-y-3">
                    <div class="flex gap-3">
                        <div class="input-group w-1/2">
                            <input id="firstName" type="text" class="field" placeholder="First Name" />
                            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        </div>
                        <div class="input-group w-1/2">
                            <input id="lastName" type="text" class="field no-icon" placeholder="Last Name" />
                        </div>
                    </div>
                    <div class="input-group">
                        <input id="email" type="email" class="field" placeholder="email@address.com" />
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </div>
                    <div class="input-group">
                        <input id="company" type="text" class="field" placeholder="Company Name" />
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-4h8v4"></path></svg>
                    </div>
                    
                    <!-- SEARCHABLE PART # DROPDOWN -->
                    <div class="input-group" id="partDropdownContainer">
                        <input id="partNumber" type="text" class="field" placeholder="Loading parts..." autocomplete="off" disabled />
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                        <div id="partsDropdown" class="no-scrollbar"></div>
                    </div>
                </div>
            </div>

            <div>
                <label class="section-label">Context</label>
                <div class="space-y-3">
                    <div class="input-group">
                        <input id="leadSubject" type="text" class="field font-medium text-slate-900" placeholder="Subject Line" />
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>
                    </div>
                    <div class="input-group">
                        <textarea id="leadMessage" rows="5" class="field" style="padding-left: 12px; min-height: 100px;" placeholder="Add notes, requirements, or quantities..."></textarea>
                    </div>
                </div>
            </div>
            <div class="h-10"></div>
        </form>
    </div>

    <div class="shrink-0 p-5 bg-white border-t border-slate-100 z-20">
        <button id="sendBtn" type="button" class="group w-full flex items-center justify-center gap-2 py-3 px-4 rounded-lg bg-blue-600 text-white font-medium text-sm hover:bg-blue-700 active:scale-[0.98] transition-all duration-200 shadow-sm disabled:opacity-70 disabled:pointer-events-none">
            <span id="btnText">Submit Lead</span>
            <svg id="btnIcon" class="w-4 h-4 transition-transform group-hover:translate-x-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            <svg id="btnSpinner" class="hidden animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        </button>
        <div class="text-center mt-3"><span class="text-[10px] text-slate-300 font-bold tracking-widest uppercase">Powered by BrandyWise</span></div>
    </div>

    <script>
        // ==========================================
        //  CONFIGURATION
        // ==========================================
        const msalConfig = {
            auth: {
                clientId: "13428380-36ba-4c1b-a4f8-79a6cc76e928", 
                authority: "https://login.microsoftonline.com/b4b6e20e-14bd-4419-bf0a-c7d2c948c513",
                redirectUri: window.location.origin + window.location.pathname, 
                supportsNestedAppAuth: true
            },
            cache: { cacheLocation: "sessionStorage" }
        };

        const graphScopes = ["Sites.ReadWrite.All", "User.Read"];
        const SITE_ID = "brandywinematerialsllc.sharepoint.com,07a1465e-a31a-4437-aca2-0efe61b7f2c6,4b1abd1c-08c6-4574-b350-654376a1e954";
        const PARTS_SITE_ID = "brandywinematerialsllc-my.sharepoint.com,34727705-4fc4-4906-af45-3912e6c67ae6,e2900843-071f-49f4-8707-dcc7f5937ebe";
        const LIST_ID_PARTS = "f8d77713-736a-4fb9-a752-b928c187c9fd";
        const LIST_ID_LEADS   = "28088675-4516-4e32-8766-ebb99cbb75e3";
        const LIST_ID_EVENTS  = "fa306d38-3403-4c29-9db8-f73c4acd63b0";
        const LIST_ID_ANCHORS = "2af7b8ed-71c0-4bff-9d04-b3237d4dd388";
        const ZAPIER_WEBHOOK_URL = "https://hooks.zapier.com/hooks/catch/REPLACE_WITH_YOUR_ID/"; 
        // ==========================================

        let msalInstance;
        let masterPartsList = []; 

        Office.onReady(async (info) => {
            if (info.host === Office.HostType.Outlook) {
                await initializeMsal();
                initializeForm();
                setupSearchableDropdown();
            }
        });

        async function initializeMsal() {
            try {
                msalInstance = await msal.createNestablePublicClientApplication(msalConfig);
            } catch (err) {
                console.error("Error initializing MSAL:", err);
                showAlert("Authentication failed to initialize.", 'error');
            }
        }

        async function getGraphAccessToken() {
            if (!msalInstance) throw new Error("MSAL not initialized");
            const account = msalInstance.getActiveAccount();
            const request = { scopes: graphScopes, account: account };
            try {
                const result = await msalInstance.acquireTokenSilent(request);
                return result.accessToken;
            } catch (error) {
                const result = await msalInstance.acquireTokenPopup(request);
                return result.accessToken;
            }
        }

        function getCurrentUser() {
            const account = msalInstance ? msalInstance.getActiveAccount() : null;
            return account ? (account.name || account.username) : "Unknown User";
        }

        async function loadPartNumbers() {
            try {
                const token = await getGraphAccessToken();
                let url = `https://graph.microsoft.com/v1.0/sites/${PARTS_SITE_ID}/lists/${LIST_ID_PARTS}/items?expand=fields(select=PartNumber)&$top=999`;
                
                masterPartsList = [];
                const searchInput = document.getElementById("partNumber");

                while (url) {
                    const response = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
                    if (!response.ok) throw new Error(`Fetch failed: ${response.status}`);
                    const data = await response.json();
                    if (data.value) {
                        data.value.forEach(item => {
                            if (item.fields?.PartNumber) masterPartsList.push(item.fields.PartNumber);
                        });
                    }
                    url = data['@odata.nextLink'] || null;
                }

                // yield thread for large array processing
                setTimeout(() => {
                    masterPartsList = [...new Set(masterPartsList)].sort((a, b) => a.localeCompare(b));
                    searchInput.disabled = false;
                    searchInput.placeholder = "Search Part #...";
                    renderDropdownOptions(masterPartsList);
                    console.log(`Ready: ${masterPartsList.length} parts.`);
                }, 50);

            } catch (err) {
                console.error("Error loading parts:", err);
                document.getElementById("partNumber").placeholder = "Error loading parts";
            }
        }

        function setupSearchableDropdown() {
            const input = document.getElementById("partNumber");
            const dropdown = document.getElementById("partsDropdown");

            input.addEventListener("focus", () => {
                if (masterPartsList.length > 0) {
                    dropdown.style.display = "block";
                    filterParts();
                }
            });

            input.addEventListener("input", filterParts);

            document.addEventListener("click", (e) => {
                if (!document.getElementById("partDropdownContainer").contains(e.target)) {
                    dropdown.style.display = "none";
                }
            });
        }

        function filterParts() {
            const query = document.getElementById("partNumber").value.toLowerCase();
            const filtered = masterPartsList.filter(p => p.toLowerCase().includes(query));
            renderDropdownOptions(filtered);
        }

        function renderDropdownOptions(parts) {
            const dropdown = document.getElementById("partsDropdown");
            const input = document.getElementById("partNumber");
            dropdown.innerHTML = "";
            
            if (parts.length === 0) {
                const div = document.createElement("div");
                div.className = "part-option text-slate-400 italic pointer-events-none";
                div.textContent = "No results found";
                dropdown.appendChild(div);
            } else {
                const limit = 100;
                parts.slice(0, limit).forEach(part => {
                    const div = document.createElement("div");
                    div.className = "part-option";
                    div.textContent = part;
                    div.onclick = () => {
                        input.value = part;
                        dropdown.style.display = "none";
                    };
                    dropdown.appendChild(div);
                });

                if (parts.length > limit) {
                    const div = document.createElement("div");
                    div.className = "part-option text-slate-400 text-[10px] text-center uppercase tracking-wider border-t bg-slate-50 font-semibold";
                    div.textContent = `Showing first ${limit} of ${parts.length} matches`;
                    dropdown.appendChild(div);
                }
            }
        }

        function updateStatusDot() {
            const status = document.getElementById("leadStatus").value;
            const dot = document.getElementById("statusDot");
            dot.classList.remove("bg-emerald-400", "bg-sky-400");
            if (status === "Open") {
                dot.classList.add("bg-emerald-400");
            } else if (status === "Ready for Quote") {
                dot.classList.add("bg-sky-400");
            }
        }

        function initializeForm() {
            const item = Office.context.mailbox.item;
            document.getElementById("leadStatus").addEventListener("change", updateStatusDot);
            updateStatusDot();

            const from = item.from || item.sender || {};
            safeSetValue("email", from.emailAddress || "");
            safeSetValue("leadSubject", item.subject || "");
            
            const nameParts = (from.displayName || "").trim().split(/\s+/);
            if (nameParts.length > 0) safeSetValue("firstName", nameParts[0]);
            if (nameParts.length > 1) safeSetValue("lastName", nameParts.slice(1).join(" "));

            safeSetValue("internetMessageId", item.internetMessageId || "");
            safeSetValue("conversationId", item.conversationId || "");

            const created = item.dateTimeCreated || new Date();
            try {
                const dt = new Date(created);
                safeSetValue("receivedTime", dt.toISOString());
            } catch {
                safeSetValue("receivedTime", new Date().toISOString());
            }

            document.getElementById("sendBtn").addEventListener("click", sendLead);
            loadPartNumbers();
        }

        function safeSetValue(id, val) {
            const el = document.getElementById(id);
            if (el) el.value = val;
        }

        function showAlert(message, type = 'error') {
            const alertBox = document.getElementById("alertBox");
            if (!message) { alertBox.classList.add("hidden"); return; }
            alertBox.classList.remove("hidden");
            alertBox.textContent = message;
            alertBox.className = type === 'success' 
                ? "mt-3 p-2 bg-emerald-50 border border-emerald-100 rounded text-xs text-emerald-700"
                : "mt-3 p-2 bg-red-50 border border-red-100 rounded text-xs text-red-600";
        }

        function setLoading(isLoading) {
            const btn = document.getElementById("sendBtn");
            btn.disabled = isLoading;
            document.getElementById("btnText").textContent = isLoading ? "Processing..." : "Submit Lead";
            document.getElementById("btnIcon").style.display = isLoading ? "none" : "block";
            document.getElementById("btnSpinner").style.display = isLoading ? "block" : "none";
        }

        function generateUUID() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        async function sendLead() {
            showAlert(null);
            const company = getValue("company");
            const subject = getValue("leadSubject");
            const partNum = getValue("partNumber");
            const email = getValue("email");
            const status = document.getElementById("leadStatus").value;

            let missing = [];
            if (!company) missing.push("Company");
            if (!subject) missing.push("Subject");
            if (!partNum) missing.push("Part #");
            if (!email) missing.push("Email");

            if (missing.length > 0) {
                showAlert("Required: " + missing.join(", "));
                return;
            }

            setLoading(true);
            try {
                if (status === "Ready for Quote") {
                    await handleZapierWorkflow({ company, subject, partNum, email, status });
                } else {
                    await handleSharePointWorkflow({ company, subject, partNum, email, status });
                }
                showAlert(`Successfully ${status === "Ready for Quote" ? "sent to Zapier" : "saved to SharePoint"}!`, 'success');
                setLoading(false);
                markEmailAsProcessed();
                setTimeout(() => Office.context.ui.closeContainer(), 2000);
            } catch (err) {
                console.error(err);
                showAlert("Error: " + err.message);
                setLoading(false);
            }
        }

        async function handleSharePointWorkflow(data) {
            const token = await getGraphAccessToken();
            const leadId = generateUUID();
            const now = new Date().toISOString();
            const currentUser = getCurrentUser();
            const headers = { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
            const baseUrl = `https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists`;

            const payloads = [
                { id: LIST_ID_LEADS, body: { fields: { Title: data.subject, LeadId: leadId, Owner: currentUser, Company: data.company, PartNumber: data.partNum, Status: data.status, CreatedAt: now, LastActivityAt: now }}},
                { id: LIST_ID_EVENTS, body: { fields: { LeadId: leadId, EventType: "System", EventAt: now, Summary: "Lead Created", Details: getValue("leadMessage") || `Created via Outlook (Status: ${data.status})` }}},
                { id: LIST_ID_ANCHORS, body: { fields: { Title: data.email, LeadId: leadId, Email: data.email, FirstName: getValue("firstName"), LastName: getValue("lastName"), ConversationId: getValue("conversationId"), StartTrackingFrom: now }}}
            ];

            const responses = await Promise.all(payloads.map(p => 
                fetch(`${baseUrl}/${p.id}/items`, { method: "POST", headers, body: JSON.stringify(p.body) })
            ));

            for (const res of responses) {
                if (!res.ok) throw new Error(`SharePoint Error: ${res.status}`);
            }
        }

        async function handleZapierWorkflow(data) {
            const payload = {
                subject: `Quote Request: ${data.partNum} for ${data.company}`,
                company: data.company, partNumber: data.partNum, email: data.email,
                firstName: getValue("firstName"), lastName: getValue("lastName"),
                message: getValue("leadMessage"), submittedAt: new Date().toISOString(),
                submittedBy: getCurrentUser(), status: data.status,
                stubUrl: "https://brandywinematerials.com/quotes/stub-update-pending" 
            };
            await fetch(ZAPIER_WEBHOOK_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(payload) });
        }

        function getValue(id) {
            const el = document.getElementById(id);
            return el ? (el.value || "").trim() : "";
        }

        function markEmailAsProcessed() {
            const item = Office.context.mailbox.item;
            item.categories.addAsync(["Lead Submitted"]);
        }
    </script>
</body>
</html>