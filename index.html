<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Lead</title>

    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@3.27.0/lib/msal-browser.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; }
        
        /* Custom UI Styles */
        .input-group { position: relative; }
        .input-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: #94a3b8; width: 16px; height: 16px; pointer-events: none; transition: color 0.2s;
        }
        .field {
            width: 100%; padding: 10px 12px 10px 36px; font-size: 0.875rem;
            color: #1e293b; background-color: #fff; border: 1px solid #e2e8f0;
            border-radius: 6px; transition: all 0.2s ease-in-out;
        }
        .field.no-icon { padding-left: 12px; }
        .field:hover { border-color: #cbd5e1; }
        .field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .field:focus + .input-icon { color: #3b82f6; }
        .section-label {
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.025em; color: #64748b; margin-bottom: 8px; display: block;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    
    <div class="shrink-0 px-5 py-4 border-b border-slate-100 bg-white z-20">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-base font-semibold text-slate-900">New Lead</h1>
                <p class="text-xs text-slate-500">Extract details from email</p>
            </div>
            <div id="statusDot" class="w-2 h-2 rounded-full bg-slate-200"></div>
        </div>
        <div id="alertBox" class="hidden mt-3 p-2 bg-red-50 border border-red-100 rounded text-xs text-red-600"></div>
    </div>

    <div class="flex-1 overflow-y-auto no-scrollbar bg-white">
        <form id="leadForm" class="px-5 py-6 space-y-6" onsubmit="return false;">
            <input type="hidden" id="internetMessageId" />
            <input type="hidden" id="conversationId" />
            <input type="hidden" id="receivedTime" />

            <div style="margin-top:0;">
                <label class="section-label">Contact Details</label>
                <div class="space-y-3">
                    <div class="flex gap-3">
                        <div class="input-group w-1/2">
                            <input id="firstName" type="text" class="field" placeholder="First Name" />
                            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        </div>
                        <div class="input-group w-1/2">
                            <input id="lastName" type="text" class="field no-icon" placeholder="Last Name" />
                        </div>
                    </div>
                    <div class="input-group">
                        <input id="email" type="email" class="field" placeholder="email@address.com" />
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </div>
                    <div class="input-group">
                        <input id="company" type="text" class="field" placeholder="Company Name" />
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-4h8v4"></path></svg>
                    </div>
                    <div class="input-group">
                        <input id="phone" type="text" class="field" placeholder="Phone Number" />
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    </div>
                </div>
            </div>

            <div>
                <label class="section-label">Context</label>
                <div class="space-y-3">
                    <div class="input-group">
                        <input id="leadSubject" type="text" class="field font-medium text-slate-900" placeholder="Subject Line" />
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>
                    </div>
                    <div class="input-group">
                        <textarea id="leadMessage" rows="5" class="field" style="padding-left: 12px; min-height: 100px;" placeholder="Add notes, requirements, or quantities..."></textarea>
                    </div>
                </div>
            </div>
            <div class="h-10"></div>
        </form>
    </div>

    <div class="shrink-0 p-5 bg-white border-t border-slate-100 z-20">
        <button id="sendBtn" type="button" class="group w-full flex items-center justify-center gap-2 py-3 px-4 rounded-lg bg-blue-600 text-white font-medium text-sm hover:bg-blue-700 active:scale-[0.98] transition-all duration-200 shadow-sm disabled:opacity-70 disabled:pointer-events-none">
            <span id="btnText">Submit Lead</span>
            <svg id="btnIcon" class="w-4 h-4 transition-transform group-hover:translate-x-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            <svg id="btnSpinner" class="hidden animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        </button>
        <div class="text-center mt-3"><span class="text-[10px] text-slate-300 font-bold tracking-widest uppercase">Powered by BrandyWise</span></div>
    </div>

    <script>
        // ==========================================
        //  CONFIGURATION (User Edits Required)
        // ==========================================
        const msalConfig = {
            auth: {
                clientId: "13428380-36ba-4c1b-a4f8-79a6cc76e928", 
                authority: "https://login.microsoftonline.com/b4b6e20e-14bd-4419-bf0a-c7d2c948c513",
                redirectUri: window.location.origin + window.location.pathname, 
                supportsNestedAppAuth: true
            },
            cache: { cacheLocation: "sessionStorage" }
        };

        const graphScopes = ["Sites.ReadWrite.All", "User.Read"];
        
        // --- SHAREPOINT CONFIG ---
        const SITE_ID = "brandywinematerialsllc.sharepoint.com,07a1465e-a31a-4437-aca2-0efe61b7f2c6,4b1abd1c-08c6-4574-b350-654376a1e954";
        
        // ! IMPORTANT: Replace these with your actual List GUIDs
        const LIST_ID_LEADS   = "28088675-4516-4e32-8766-ebb99cbb75e3";
        const LIST_ID_EVENTS  = "fa306d38-3403-4c29-9db8-f73c4acd63b0";
        const LIST_ID_ANCHORS = "2af7b8ed-71c0-4bff-9d04-b3237d4dd388";
        // ==========================================

        let msalInstance;

        Office.onReady(async (info) => {
            if (info.host === Office.HostType.Outlook) {
                await initializeMsal();
                initializeForm();
            }
        });

        // --- AUTH ---
        async function initializeMsal() {
            try {
                msalInstance = await msal.createNestablePublicClientApplication(msalConfig);
                console.log("MSAL Initialized with NAA support");
            } catch (err) {
                console.error("Error initializing MSAL:", err);
                showAlert("Authentication failed to initialize.", 'error');
            }
        }

        async function getGraphAccessToken() {
            if (!msalInstance) throw new Error("MSAL not initialized");
            const account = msalInstance.getActiveAccount();
            const request = { scopes: graphScopes, account: account };
            try {
                const result = await msalInstance.acquireTokenSilent(request);
                return result.accessToken;
            } catch (error) {
                const result = await msalInstance.acquireTokenPopup(request);
                return result.accessToken;
            }
        }

        function getCurrentUser() {
            // Returns the name of the logged-in user from the MSAL account
            const account = msalInstance ? msalInstance.getActiveAccount() : null;
            return account ? (account.name || account.username) : "Unknown User";
        }

        // --- UI ---
        function initializeForm() {
            const item = Office.context.mailbox.item;

            // Status indicator
            document.getElementById("statusDot").classList.remove("bg-slate-200");
            document.getElementById("statusDot").classList.add("bg-emerald-400");

            const from = item.from || item.sender || {};
            const leadEmail = from.emailAddress || "";
            const leadName = from.displayName || "";
            
            safeSetValue("email", leadEmail);
            safeSetValue("leadSubject", item.subject || "");
            
            const parts = (leadName || "").trim().split(/\s+/);
            if (parts.length > 0) safeSetValue("firstName", parts[0]);
            if (parts.length > 1) safeSetValue("lastName", parts.slice(1).join(" "));

            safeSetValue("internetMessageId", item.internetMessageId || "");
            safeSetValue("conversationId", item.conversationId || "");

            const created = item.dateTimeCreated || new Date();
            try {
                const dt = created instanceof Date ? created : new Date(created);
                safeSetValue("receivedTime", dt.toISOString());
            } catch {
                safeSetValue("receivedTime", new Date().toISOString());
            }

            document.getElementById("sendBtn").addEventListener("click", sendLead);
        }

        function safeSetValue(id, val) {
            const el = document.getElementById(id);
            if (el) el.value = val;
        }

        function showAlert(message, type = 'error') {
            const alertBox = document.getElementById("alertBox");
            if (!message) {
                alertBox.classList.add("hidden");
                return;
            }
            alertBox.classList.remove("hidden");
            alertBox.textContent = message;
            if (type === 'success') {
                alertBox.className = "mt-3 p-2 bg-emerald-50 border border-emerald-100 rounded text-xs text-emerald-700";
            } else {
                alertBox.className = "mt-3 p-2 bg-red-50 border border-red-100 rounded text-xs text-red-600";
            }
        }

        function setLoading(isLoading) {
            const btn = document.getElementById("sendBtn");
            btn.disabled = isLoading;
            document.getElementById("btnText").textContent = isLoading ? "Processing..." : "Submit Lead";
            document.getElementById("btnIcon").style.display = isLoading ? "none" : "block";
            document.getElementById("btnSpinner").style.display = isLoading ? "block" : "none";
        }

        // --- HELPERS ---
        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- MAIN LOGIC ---
        async function sendLead() {
            showAlert(null);
            setLoading(true);

            try {
                // 1. Get Token & Setup
                const token = await getGraphAccessToken();
                const leadId = generateUUID();
                const now = new Date().toISOString();
                const currentUser = getCurrentUser();

                // 2. Prepare Payloads
                // NOTE: Keys below (e.g. "LeadId", "Owner") must match SharePoint INTERNAL names.
                // If you created columns via UI, check settings for internal names (often field_1, etc.)
                
                // A. LIST: BWLeads
                const leadPayload = {
                    fields: {
                        Title: getValue("leadSubject"), // Mandatory Title field
                        LeadId: leadId,
                        Owner: currentUser,
                        Company: getValue("company"),
                        Status: "Open",
                        CreatedAt: now,
                        LastActivityAt: now
                    }
                };

                // B. LIST: BWLeadEvents
                const eventPayload = {
                    fields: {
                        LeadId: leadId,
                        EventType: "System", // Initial creation event
                        EventAt: now,
                        Summary: "Lead Created",
                        Details: getValue("leadMessage") || "Created via Outlook Add-in"
                    }
                };

                // C. LIST: BWEmailAnchors
                const anchorPayload = {
                    fields: {
                        Title: getValue("email"), // Usually Title is required, mapped to Email or generic
                        LeadId: leadId,
                        Email: getValue("email"),
                        FirstName: getValue("firstName"),
                        LastName: getValue("lastName"),
                        ConversationId: getValue("conversationId"),
                        StartTrackingFrom: now
                    }
                };

                // 3. Execute Requests (Parallel)
                const headers = { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
                const baseUrl = `https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists`;

                const reqLeads = fetch(`${baseUrl}/${LIST_ID_LEADS}/items`, { method: "POST", headers, body: JSON.stringify(leadPayload) });
                const reqEvents = fetch(`${baseUrl}/${LIST_ID_EVENTS}/items`, { method: "POST", headers, body: JSON.stringify(eventPayload) });
                const reqAnchors = fetch(`${baseUrl}/${LIST_ID_ANCHORS}/items`, { method: "POST", headers, body: JSON.stringify(anchorPayload) });

                // Await all
                const responses = await Promise.all([reqLeads, reqEvents, reqAnchors]);

                // Check errors
                for (const res of responses) {
                    if (!res.ok) {
                        const errText = await res.text();
                        throw new Error(`SharePoint Error (${res.status}): ${errText}`);
                    }
                }

                // 4. Success UI
                showAlert("Lead & Anchors created successfully!", 'success');
                setLoading(false);
                markEmailAsProcessed();
                
                setTimeout(() => { try { Office.context.ui.closeContainer(); } catch {} }, 2000);

            } catch (err) {
                console.error(err);
                showAlert("Error: " + err.message, 'error');
                setLoading(false);
            }
        }

        function getValue(id) {
            return (document.getElementById(id).value || "").trim();
        }

        function markEmailAsProcessed() {
            const item = Office.context.mailbox.item;
            item.categories.addAsync(["Lead Submitted"], (result) => {
                if (result.status === Office.AsyncResultStatus.Failed) {
                    console.log("Could not add category.");
                }
            });
        }
    </script>
</body>
</html>