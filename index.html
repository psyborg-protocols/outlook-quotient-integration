<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Lead</title>

    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@3.27.0/lib/msal-browser.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; }
        
        /* Custom UI Styles */
        .input-group { position: relative; }
        .input-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: #94a3b8; width: 16px; height: 16px; pointer-events: none; transition: color 0.2s;
        }
        .field {
            width: 100%; padding: 10px 12px 10px 36px; font-size: 0.875rem;
            color: #1e293b; background-color: #fff; border: 1px solid #e2e8f0;
            border-radius: 6px; transition: all 0.2s ease-in-out;
        }
        .field:disabled { background-color: #f8fafc; color: #94a3b8; cursor: not-allowed; }
        .field.no-icon { padding-left: 12px; }
        .field:hover:not(:disabled) { border-color: #cbd5e1; }
        .field:focus:not(:disabled) { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .field:focus + .input-icon { color: #3b82f6; }
        .section-label {
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.025em; color: #64748b; margin-bottom: 8px; display: block;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Prettier Status Dropdown Custom Styling */
        .status-trigger {
            display: flex; align-items: center; gap: 8px;
            padding: 4px 8px; margin-left: -8px; border-radius: 6px;
            transition: background 0.2s; cursor: pointer;
        }
        .status-trigger:hover { background: #f1f5f9; }
        
        #statusDropdownMenu {
            display: none; position: absolute; top: 100%; left: 1.25rem;
            width: 180px; margin-top: 4px; background: white; 
            border: 1px solid #e2e8f0; border-radius: 8px; z-index: 60;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden; animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .status-option {
            padding: 10px 12px; font-size: 0.875rem; color: #334155;
            display: flex; align-items: center; gap: 10px; cursor: pointer; transition: background 0.1s;
        }
        .status-option:hover { background: #f8fafc; color: #0f172a; }
        .status-option.active { font-weight: 600; color: #2563eb; background: #eff6ff; }

        /* Parts Dropdown */
        #partsDropdown {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            max-height: 220px; overflow-y: auto; background: white; border: 1px solid #e2e8f0;
            border-top: none; border-radius: 0 0 6px 6px; z-index: 50;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .part-option {
            padding: 10px 12px; font-size: 0.875rem; color: #1e293b;
            cursor: pointer; transition: background 0.1s; border-bottom: 1px solid #f8fafc;
        }
        .part-option:last-child { border-bottom: none; }
        .part-option:hover { background-color: #f1f5f9; color: #2563eb; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    
    <!-- HEADER WITH PRETTIER STATUS DROPDOWN -->
    <div class="shrink-0 px-5 py-4 border-b border-slate-100 bg-white z-20 relative">
        <div class="flex justify-between items-center">
            <div class="relative">
                <div id="statusTrigger" class="status-trigger group">
                    <span id="currentStatusText" class="text-base font-semibold text-slate-900 select-none">New Lead</span>
                    <svg class="w-4 h-4 text-slate-400 group-hover:text-slate-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                
                <!-- Custom Menu -->
                <div id="statusDropdownMenu">
                    <div class="status-option active" data-value="Open" data-label="New Lead">
                        <div class="w-2 h-2 rounded-full bg-emerald-400"></div>
                        New Lead
                    </div>
                    <div class="status-option" data-value="Ready for Quote" data-label="Ready for Quote">
                        <div class="w-2 h-2 rounded-full bg-sky-400"></div>
                        Ready for Quote
                    </div>
                </div>
            </div>
            <div id="statusDot" class="w-2.5 h-2.5 rounded-full bg-emerald-400 transition-colors duration-300 shadow-sm"></div>
        </div>
        <div id="alertBox" class="hidden mt-3 p-2 bg-red-50 border border-red-100 rounded text-xs text-red-600"></div>
    </div>

    <div class="flex-1 overflow-y-auto no-scrollbar bg-white">
        <form id="leadForm" class="px-5 py-6 space-y-6" onsubmit="return false;">
            <input type="hidden" id="internetMessageId" />
            <input type="hidden" id="conversationId" />
            <input type="hidden" id="receivedTime" />
            <input type="hidden" id="leadStatusValue" value="Open" />

            <div style="margin-top:0;">
                <label class="section-label">Contact Details</label>
                <div class="space-y-3">
                    <div class="flex gap-3">
                        <div class="input-group w-1/2">
                            <input id="firstName" type="text" class="field" placeholder="First Name" />
                            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        </div>
                        <div class="input-group w-1/2">
                            <input id="lastName" type="text" class="field no-icon" placeholder="Last Name" />
                        </div>
                    </div>
                    <div class="input-group">
                        <input id="email" type="email" class="field" placeholder="email@address.com" />
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </div>
                    <div class="input-group">
                        <input id="company" type="text" class="field" placeholder="Company Name" />
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-4h8v4"></path></svg>
                    </div>
                    
                    <div class="input-group" id="partDropdownContainer">
                        <input id="partNumber" type="text" class="field" placeholder="Loading parts..." autocomplete="off" disabled />
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                        <div id="partsDropdown" class="no-scrollbar"></div>
                    </div>
                </div>
            </div>

            <div>
                <label class="section-label">Context</label>
                <div class="space-y-3">
                    <div class="input-group">
                        <input id="leadSubject" type="text" class="field font-medium text-slate-900" placeholder="Subject Line" />
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>
                    </div>
                    <div class="input-group">
                        <textarea id="leadMessage" rows="5" class="field" style="padding-left: 12px; min-height: 100px;" placeholder="Add notes, requirements, or quantities..."></textarea>
                    </div>
                </div>
            </div>
            <div class="h-10"></div>
        </form>
    </div>

    <div class="shrink-0 p-5 bg-white border-t border-slate-100 z-20">
        <button id="sendBtn" type="button" class="group w-full flex items-center justify-center gap-2 py-3 px-4 rounded-lg bg-blue-600 text-white font-medium text-sm hover:bg-blue-700 active:scale-[0.98] transition-all duration-200 shadow-sm disabled:opacity-70 disabled:pointer-events-none">
            <span id="btnText">Submit Lead</span>
            <svg id="btnIcon" class="w-4 h-4 transition-transform group-hover:translate-x-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            <svg id="btnSpinner" class="hidden animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        </button>
        <div class="text-center mt-3"><span class="text-[10px] text-slate-300 font-bold tracking-widest uppercase">Powered by BrandyWise</span></div>
    </div>

    <script>
        // ==========================================
        //  CONFIGURATION
        // ==========================================
        const msalConfig = {
            auth: {
                clientId: "13428380-36ba-4c1b-a4f8-79a6cc76e928", 
                authority: "https://login.microsoftonline.com/b4b6e20e-14bd-4419-bf0a-c7d2c948c513",
                redirectUri: window.location.origin + window.location.pathname, 
                supportsNestedAppAuth: true
            },
            cache: { cacheLocation: "sessionStorage" }
        };

        const graphScopes = ["Sites.ReadWrite.All", "User.Read", "Contacts.Read"]; // Added Contacts.Read
        const SITE_ID = "brandywinematerialsllc.sharepoint.com,07a1465e-a31a-4437-aca2-0efe61b7f2c6,4b1abd1c-08c6-4574-b350-654376a1e954";
        const PARTS_SITE_ID = "brandywinematerialsllc-my.sharepoint.com,34727705-4fc4-4906-af45-3912e6c67ae6,e2900843-071f-49f4-8707-dcc7f5937ebe";
        const LIST_ID_PARTS = "f8d77713-736a-4fb9-a752-b928c187c9fd";
        const LIST_ID_LEADS   = "28088675-4516-4e32-8766-ebb99cbb75e3";
        const LIST_ID_EVENTS  = "fa306d38-3403-4c29-9db8-f73c4acd63b0";
        const LIST_ID_ANCHORS = "2af7b8ed-71c0-4bff-9d04-b3237d4dd388";
        const ZAPIER_WEBHOOK_URL = "https://hooks.zapier.com/hooks/catch/REPLACE_WITH_YOUR_ID/"; 

        const CACHE_KEY = "parts_list_cache";
        const CACHE_TIME_KEY = "parts_list_timestamp";
        const CACHE_EXPIRY = 24 * 60 * 60 * 1000; 
        // ==========================================

        let msalInstance;
        let masterPartsList = []; 

        Office.onReady(async (info) => {
            if (info.host === Office.HostType.Outlook) {
                await initializeMsal();
                initializeForm();
                setupSearchableDropdown();
                setupStatusDropdown();
            }
        });

        async function initializeMsal() {
            try {
                msalInstance = await msal.createNestablePublicClientApplication(msalConfig);
            } catch (err) {
                console.error("Error MSAL:", err);
                showAlert("Authentication failed.");
            }
        }

        async function getGraphAccessToken() {
            if (!msalInstance) throw new Error("MSAL not initialized");
            const account = msalInstance.getActiveAccount();
            const request = { scopes: graphScopes, account: account };
            try {
                const result = await msalInstance.acquireTokenSilent(request);
                return result.accessToken;
            } catch (error) {
                const result = await msalInstance.acquireTokenPopup(request);
                return result.accessToken;
            }
        }

        function getCurrentUser() {
            const account = msalInstance ? msalInstance.getActiveAccount() : null;
            return account ? (account.name || account.username) : "Unknown User";
        }

        // --- STATUS DROPDOWN LOGIC ---
        function setupStatusDropdown() {
            const trigger = document.getElementById("statusTrigger");
            const menu = document.getElementById("statusDropdownMenu");
            const options = document.querySelectorAll(".status-option");
            const statusHiddenInput = document.getElementById("leadStatusValue");
            const currentText = document.getElementById("currentStatusText");
            const dot = document.getElementById("statusDot");

            trigger.addEventListener("click", (e) => {
                e.stopPropagation();
                const isVisible = menu.style.display === "block";
                menu.style.display = isVisible ? "none" : "block";
            });

            options.forEach(opt => {
                opt.addEventListener("click", () => {
                    const val = opt.getAttribute("data-value");
                    const label = opt.getAttribute("data-label");
                    
                    statusHiddenInput.value = val;
                    currentText.textContent = label;
                    
                    dot.classList.remove("bg-emerald-400", "bg-sky-400");
                    dot.classList.add(val === "Open" ? "bg-emerald-400" : "bg-sky-400");
                    
                    options.forEach(o => o.classList.remove("active"));
                    opt.classList.add("active");
                    
                    menu.style.display = "none";
                });
            });

            document.addEventListener("click", () => { menu.style.display = "none"; });
        }

        // --- PARTS LOGIC ---
        async function loadPartNumbers() {
            const searchInput = document.getElementById("partNumber");
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
            const isExpired = !cachedTime || (Date.now() - parseInt(cachedTime)) > CACHE_EXPIRY;

            if (cachedData) {
                try {
                    masterPartsList = JSON.parse(cachedData);
                    searchInput.disabled = false;
                    searchInput.placeholder = "Search Part #...";
                    renderDropdownOptions(masterPartsList);
                    if (!isExpired) return;
                } catch (e) { localStorage.removeItem(CACHE_KEY); }
            }

            fetchFreshParts(searchInput);
        }

        async function fetchFreshParts(searchInput) {
            try {
                const token = await getGraphAccessToken();
                let url = `https://graph.microsoft.com/v1.0/sites/${PARTS_SITE_ID}/lists/${LIST_ID_PARTS}/items?expand=fields(select=PartNumber)&$top=999`;
                let freshParts = [];
                while (url) {
                    const response = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
                    if (!response.ok) throw new Error(`Fetch failed`);
                    const data = await response.json();
                    if (data.value) data.value.forEach(item => { if (item.fields?.PartNumber) freshParts.push(item.fields.PartNumber); });
                    url = data['@odata.nextLink'] || null;
                }

                setTimeout(() => {
                    masterPartsList = [...new Set(freshParts)].sort((a, b) => a.localeCompare(b));
                    localStorage.setItem(CACHE_KEY, JSON.stringify(masterPartsList));
                    localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
                    searchInput.disabled = false;
                    searchInput.placeholder = "Search Part #...";
                    filterParts(); 
                }, 50);
            } catch (err) { console.error(err); }
        }

        function setupSearchableDropdown() {
            const input = document.getElementById("partNumber");
            const dropdown = document.getElementById("partsDropdown");
            input.addEventListener("focus", () => { if (masterPartsList.length > 0) { dropdown.style.display = "block"; filterParts(); } });
            input.addEventListener("input", filterParts);
            document.addEventListener("click", (e) => { if (!document.getElementById("partDropdownContainer").contains(e.target)) dropdown.style.display = "none"; });
        }

        function filterParts() {
            const query = document.getElementById("partNumber").value.toLowerCase();
            const filtered = masterPartsList.filter(p => p.toLowerCase().includes(query));
            renderDropdownOptions(filtered);
        }

        function renderDropdownOptions(parts) {
            const dropdown = document.getElementById("partsDropdown");
            const input = document.getElementById("partNumber");
            dropdown.innerHTML = "";
            if (parts.length === 0) {
                const div = document.createElement("div");
                div.className = "part-option text-slate-400 italic pointer-events-none";
                div.textContent = "No results found";
                dropdown.appendChild(div);
            } else {
                const limit = 100;
                parts.slice(0, limit).forEach(part => {
                    const div = document.createElement("div");
                    div.className = "part-option";
                    div.textContent = part;
                    div.onclick = () => { input.value = part; dropdown.style.display = "none"; };
                    dropdown.appendChild(div);
                });
                if (parts.length > limit) {
                    const div = document.createElement("div");
                    div.className = "part-option text-slate-400 text-[10px] text-center uppercase tracking-wider border-t bg-slate-50 font-semibold";
                    div.textContent = `Showing first ${limit} of ${parts.length} matches`;
                    dropdown.appendChild(div);
                }
            }
        }

        // --- AUTO-FILL HELPERS ---
        function extractCompanyFromEmail(email) {
            if (!email || !email.includes('@')) return "";
            const domain = email.split('@')[1].toLowerCase();
            const commonProviders = ['gmail.com', 'outlook.com', 'hotmail.com', 'yahoo.com', 'icloud.com', 'aol.com', 'msn.com'];
            if (commonProviders.includes(domain)) return "";
            let company = domain.split('.')[0];
            return company.charAt(0).toUpperCase() + company.slice(1);
        }

        async function resolveCompanyInfo(email) {
            if (!email) return;

            // Step 1: Try Graph Search (Contacts & Directory)
            try {
                const token = await getGraphAccessToken();
                
                // First attempt: Check Personal Contacts
                const contactUrl = `https://graph.microsoft.com/v1.0/me/contacts?$filter=emailAddresses/any(a:a/address eq '${email}')&$select=companyName`;
                const contactRes = await fetch(contactUrl, { headers: { "Authorization": `Bearer ${token}` } });
                
                if (contactRes.ok) {
                    const data = await contactRes.json();
                    if (data.value && data.value.length > 0 && data.value[0].companyName) {
                        safeSetValue("company", data.value[0].companyName);
                        console.log("Company found in contacts:", data.value[0].companyName);
                        return;
                    }
                }

                // Second attempt: Check Organization Directory (Global Address List)
                const userUrl = `https://graph.microsoft.com/v1.0/users?$filter=mail eq '${email}' or userPrincipalName eq '${email}'&$select=companyName`;
                const userRes = await fetch(userUrl, { headers: { "Authorization": `Bearer ${token}` } });

                if (userRes.ok) {
                    const data = await userRes.json();
                    if (data.value && data.value.length > 0 && data.value[0].companyName) {
                        safeSetValue("company", data.value[0].companyName);
                        console.log("Company found in directory:", data.value[0].companyName);
                        return;
                    }
                }
            } catch (err) {
                console.warn("Graph contact search failed:", err);
            }

            // Step 3: Fallback to Domain Extraction if Graph found nothing
            const suggested = extractCompanyFromEmail(email);
            if (suggested) safeSetValue("company", suggested);
        }

        async function initializeForm() {
            const item = Office.context.mailbox.item;
            const from = item.from || item.sender || {};
            const leadEmail = from.emailAddress || "";
            
            safeSetValue("email", leadEmail);
            safeSetValue("leadSubject", item.subject || "");
            
            // Trigger smarter company resolution
            resolveCompanyInfo(leadEmail);

            const nameParts = (from.displayName || "").trim().split(/\s+/);
            if (nameParts.length > 0) safeSetValue("firstName", nameParts[0]);
            if (nameParts.length > 1) safeSetValue("lastName", nameParts.slice(1).join(" "));
            
            safeSetValue("internetMessageId", item.internetMessageId || "");
            safeSetValue("conversationId", item.conversationId || "");
            
            try { safeSetValue("receivedTime", new Date(item.dateTimeCreated).toISOString()); } catch { safeSetValue("receivedTime", new Date().toISOString()); }
            
            document.getElementById("sendBtn").addEventListener("click", sendLead);
            loadPartNumbers();
        }

        function safeSetValue(id, val) { const el = document.getElementById(id); if (el) el.value = val; }
        function getValue(id) { const el = document.getElementById(id); return el ? (el.value || "").trim() : ""; }

        function showAlert(message, type = 'error') {
            const alertBox = document.getElementById("alertBox");
            if (!message) { alertBox.classList.add("hidden"); return; }
            alertBox.classList.remove("hidden");
            alertBox.textContent = message;
            alertBox.className = type === 'success' 
                ? "mt-3 p-2 bg-emerald-50 border border-emerald-100 rounded text-xs text-emerald-700"
                : "mt-3 p-2 bg-red-50 border border-red-100 rounded text-xs text-red-600";
        }

        async function sendLead() {
            showAlert(null);
            const data = {
                company: getValue("company"), subject: getValue("leadSubject"),
                partNum: getValue("partNumber"), email: getValue("email"),
                status: document.getElementById("leadStatusValue").value
            };

            let missing = [];
            if (!data.company) missing.push("Company");
            if (!data.subject) missing.push("Subject");
            if (!data.partNum) missing.push("Part #");
            if (!data.email) missing.push("Email");

            if (missing.length > 0) { showAlert("Required: " + missing.join(", ")); return; }

            setLoading(true);
            try {
                if (data.status === "Ready for Quote") { await handleZapierWorkflow(data); } 
                else { await handleSharePointWorkflow(data); }
                showAlert("Success!", 'success');
                markEmailAsProcessed();
                setTimeout(() => Office.context.ui.closeContainer(), 2000);
            } catch (err) { showAlert(err.message); } finally { setLoading(false); }
        }

        async function handleSharePointWorkflow(data) {
            const token = await getGraphAccessToken();
            const leadId = generateUUID();
            const now = new Date().toISOString();
            const headers = { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
            const baseUrl = `https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists`;

            const payloads = [
                { id: LIST_ID_LEADS, body: { fields: { Title: data.subject, LeadId: leadId, Owner: getCurrentUser(), Company: data.company, PartNumber: data.partNum, Status: data.status, CreatedAt: now, LastActivityAt: now }}},
                { id: LIST_ID_EVENTS, body: { fields: { LeadId: leadId, EventType: "System", EventAt: now, Summary: "Lead Created", Details: getValue("leadMessage") || `Outlook (Status: ${data.status})` }}},
                { id: LIST_ID_ANCHORS, body: { fields: { Title: data.email, LeadId: leadId, Email: data.email, FirstName: getValue("firstName"), LastName: getValue("lastName"), ConversationId: getValue("conversationId"), StartTrackingFrom: now }}}
            ];

            const res = await Promise.all(payloads.map(p => fetch(`${baseUrl}/${p.id}/items`, { method: "POST", headers, body: JSON.stringify(p.body) })));
            if (res.some(r => !r.ok)) throw new Error(`Sync Error`);
        }

        async function handleZapierWorkflow(data) {
            const payload = {
                subject: `Quote Request: ${data.partNum} for ${data.company}`,
                company: data.company, partNumber: data.partNum, email: data.email,
                firstName: getValue("firstName"), lastName: getValue("lastName"),
                message: getValue("leadMessage"), submittedAt: new Date().toISOString(),
                submittedBy: getCurrentUser(), status: data.status,
                stubUrl: "https://brandywinematerials.com/quotes/stub-update-pending" 
            };
            await fetch(ZAPIER_WEBHOOK_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(payload) });
        }

        function generateUUID() { return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)); }
        function setLoading(isLoading) {
            const btn = document.getElementById("sendBtn");
            btn.disabled = isLoading;
            document.getElementById("btnText").textContent = isLoading ? "Processing..." : "Submit Lead";
            document.getElementById("btnSpinner").style.display = isLoading ? "block" : "none";
            document.getElementById("btnIcon").style.display = isLoading ? "none" : "block";
        }
        function markEmailAsProcessed() { Office.context.mailbox.item.categories.addAsync(["Lead Submitted"]); }
    </script>
</body>
</html>